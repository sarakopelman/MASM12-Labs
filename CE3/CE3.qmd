---
title: "CE3"
author: "Markus Gerholm, Sara Kopelman, Erik Göransson"
format: html
editor: visual
---

# CE3

## Part 1: Simulation and discretization of diffusion processes

## Question 1a

```{r}
# Parameters
delta <- 2^(-9)
theta <- c(0.7, 0.8, 3.0, -0.34)
sigma <- c(0, 0.1, 0.2, 0.3, 0.4)
N <- 100/delta
```

## Simulating Y

```{r}
Y_1 <- rep(NA, N)
Y_2 <-rep(NA,N)
Y_1[1] <- -1.9
Y_2[1] <- 1.2

for(t in 2:N){
  Y_1[t] <- Y_1[t-1] + theta[3] * (Y_1[t-1] + Y_2[t-1] - (Y_1[t-1]^3)/3 + theta[4]) * delta + sigma[4] * sqrt(delta) * rnorm(1)
  Y_2[t] <- Y_2[t-1] - ((Y_1[t-1] + theta[2] * Y_2[t-1] - theta[1])/theta[3]) * delta
}
```

```{r}
par(mfrow = c(1,3), mar = c(4,4,2,1))  # 1 row, 3 columns

plot(Y_1, Y_2, type = "l")
plot(Y_1, type = "l")
plot(Y_2, type = "l")
```

## Question 1b

```{r}
# Creating grid
X <- seq(-3, 3, length.out = 100)
Y <- seq(-2, 2, length.out = 100)

snap_to_grid_simple <- function(x, grid) {
  sapply(x, function(xx) {
    if (is.na(xx)) return(NA_real_)
    g <- grid[which.min(abs(grid - xx))]
    return(g)
  })
}

Y1_snap <- snap_to_grid_simple(Y_1, X)
Y2_snap <- snap_to_grid_simple(Y_2, Y)

df <- data.frame(x = Y1_snap, y = Y2_snap)
heat_df <- as.data.frame(table(df))

bin_counts <- hist2d <- hist2d <- function(x, y, xbreaks, ybreaks) {
  counts <- table(
    cut(x, xbreaks, include.lowest = TRUE),
    cut(y, ybreaks, include.lowest = TRUE)
  )
  list(
    x = midpoints(xbreaks),
    y = midpoints(ybreaks),
    z = t(apply(counts, 2, as.numeric))
  )
}
midpoints <- function(breaks) (head(breaks, -1) + tail(breaks, -1)) / 2

h2d <- hist2d(Y_1, Y_2, X, Y)

plot_ly(
  x = h2d$x,
  y = h2d$y,
  z = h2d$z,
  type = "surface",
  colorscale = "Plasma"
) |>
  layout(
    scene = list(
      xaxis = list(title = "Y1"),
      yaxis = list(title = "Y2"),
      zaxis = list(title = "Count", showticklabels = TRUE),
      camera = list(eye = list(x = 1.5, y = 1.5, z = 1))
    )
  )
```

## Part 2: Modelling a building using CSTM-R

```{r}
library(ctsmr)
#Start with simple model for room 4
source("Data/sdeTiTm.R")
load("Data/Exercise3.RData")
```

```{r}
#plotting
library(ggplot2)
library(dplyr)

ggplot(AllDat, aes(x = date, y = yTi4)) +
  geom_line() +
  labs(title = "Room 4 Temperature (yTi4)",
       x = "Date", y = "Temperature (°C)") +
  scale_x_datetime(date_labels = "%Y-%m-%d", date_breaks = "2 week") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(AllDat, aes(x = date)) +
  geom_line(aes(y = yTi4, color = "Room 4 (yTi4)")) +
  geom_line(aes(y = Ta,   color = "Outdoor (Ta)")) +
  labs(title = "Room 4 vs Outdoor Temperature",
       x = "Date", y = "Temperature (°C)", color = "") +
  scale_color_manual(values = c("Room 4 (yTi4)" = "blue", "Outdoor (Ta)" = "red")) +
  scale_x_datetime(date_labels = "%Y-%m-%d", date_breaks = "1 week") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

library(tidyr)

df_plot <- AllDat |> 
  select(date, yTi4, Ta, Ph2, Gv) |> 
  pivot_longer(-date, names_to = "variable", values_to = "value")

ggplot(df_plot, aes(x = date, y = value)) +
  geom_line() +
  facet_wrap(~ variable, scales = "free_y", ncol = 1) +
  labs(title = "Room 4 Related Variables",
       x = "Date", y = "") +
  scale_x_datetime(date_labels = "%Y-%m-%d", date_breaks = "2 weeks") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

library(corrplot)

cor_mat <- cor(AllDat[, c("yTi4", "Ta", "Gv", "Ph1", "Ph2")],
               use = "pairwise.complete.obs")

corrplot(cor_mat,
         method = "color",       # colored squares
         type = "upper",         # only upper triangle
         addCoef.col = "black",  # show correlation coefficients in black
         tl.cex = 1,             # text label size
         number.cex = 0.8,       # coefficient size
         tl.col = "black")        # label color


```

```{r}
library(ggplot2)
library(dplyr)
library(lubridate)

# Extract Hour
Hour <- as.numeric(strftime(AllDat$date, format="%H"))
AllDat$Hour <- Hour
# Create long-format dataframe for faceting
df_plot <- data.frame(
  Hour = rep(AllDat$Hour, 3),
  variable = factor(rep(c("Room 4 (yTi4)", "Outdoor (Ta)", "Solar (Gv)"),
                        each = nrow(AllDat))),
  value = c(AllDat$yTi4, AllDat$Ta, AllDat$Gv)
)

# Compute Hourly mean for each variable
Hourly_mean <- df_plot %>%
  group_by(variable, Hour) %>%
  summarise(mean_val = mean(value, na.rm = TRUE), .groups = "drop")

# Facet scatter plot with mean lines
ggplot(df_plot, aes(x = Hour, y = value)) +
  geom_jitter(width = 0.2, alpha = 0.3, color = "steelblue") +
  geom_line(data = Hourly_mean, aes(x = Hour, y = mean_val), color = "black", size = 1) +
  facet_wrap(~ variable, scales = "free_y", ncol = 1) +
  labs(title = "Hourly Scatter: Room Temperature, Outdoor Temp, and Solar Radiation",
       x = "Hour of Day", y = "") +
  scale_x_continuous(breaks = 0:23) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))


```

```{r}
library(splines)
# add splines
idx <- (Hour>8 & Hour < 23) # It is impossible to fit a window area for the hours without any sun, so we limit the window area estimation to the hours with sun.
bs = bs(Hour[idx],df=5,intercept=TRUE) 

# What does the splines look like?
plot(bs[14:27,1],type='l')
lines(bs[ 14:27,2])
lines(bs[ 14:27,3])
lines(bs[ 14:27,4])
lines(bs[ 14:27,5])

bs1 <- bs2 <- bs3 <- bs4 <- bs5 <- bs6 <- numeric(dim(AllDat)[1])

bs1[idx] = bs[,1]
bs2[idx] = bs[,2]
bs3[idx] = bs[,3]
bs4[idx] = bs[,4]
bs5[idx] = bs[,5]

AllDat$bs1 = bs1
AllDat$bs2 = bs2
AllDat$bs3 = bs3
AllDat$bs4 = bs4
AllDat$bs5 = bs5
```

```{r}
# Define train/test split: for example, 80% train, 20% test

n_total <- nrow(AllDat)
n_train <- floor(0.8 * n_total)

# Create train and test datasets
train_data <- AllDat[1:n_train, ]
test_data  <- AllDat[(n_train + 1):n_total, ]
test_data <- test_data %>%
  rename(yTi = yTi4, Ph = Ph1)

# Optional: show date ranges
cat("Training set: ", min(train_data$date), " to ", max(train_data$date), "\n")
cat("Test set: ", min(test_data$date), " to ", max(test_data$date), "\n")

```

 

```{r}
plot_residuals_train_test <- function(fit, train_data, test_data) {
  library(dplyr)
  library(ggplot2)
  library(lubridate)
  library(tidyr)
  
  # --- TRAIN DATA ---
  Pred <- predict(fit)
  
  # One-step-ahead naive predictor
  train_data <- train_data %>%
    arrange(date) %>%
    mutate(Naive = lag(yTi4))
  
  # Remove first row and first day
  first_day <- as.Date(min(train_data$date))
  df_resid_plot <- train_data %>% 
    slice(-1) %>%                        
    filter(as.Date(date) > first_day)
  
  # Align model predictions
  Pred_train <- Pred[[1]]$state$pred$Ti[-1]
  Pred_train <- Pred_train[as.Date(train_data$date[-1]) > first_day]
  
  # Compute residuals
  df_resid_plot <- df_resid_plot %>%
    mutate(
      Resid_Model = Pred_train - yTi4,
      Resid_Naive = Naive - yTi4
    )
  
  # Residuals by hour plot
  df_hour_resid <- df_resid_plot %>% mutate(Hour = hour(date))
  hour_plot_train <- ggplot(df_hour_resid, aes(x = Hour, y = Resid_Model)) +
    geom_jitter(width = 0.2, alpha = 0.3, color = "steelblue") +
    stat_summary(fun = mean, geom = "line", aes(group = 1), color = "black", size = 1) +
    scale_x_continuous(breaks = 0:23) +
    labs(title = "Residuals of One-Step-Ahead Prediction by Hour (Train Data, Filtered)",
         x = "Hour of Day",
         y = "Residual (Predicted - Actual)") +
    theme_minimal()
  
  # Stacked residual plot
  df_long <- df_resid_plot %>%
    select(date, Resid_Model, Resid_Naive) %>%
    pivot_longer(cols = c(Resid_Model, Resid_Naive),
                 names_to = "Predictor", values_to = "Residual") %>%
    mutate(Predictor = factor(Predictor, 
                              levels = c("Resid_Model", "Resid_Naive"),
                              labels = c("Model Residual", "Naive Residual")))
  
  rmse_model_train <- sqrt(mean(df_resid_plot$Resid_Model^2))
  rmse_naive_train <- sqrt(mean(df_resid_plot$Resid_Naive^2))
  
  stacked_plot_train <- ggplot(df_long, aes(x = date, y = Residual)) +
    geom_line(aes(color = Predictor), size = 1) +
    geom_hline(yintercept = 0, linetype = "dotted") +
    scale_color_manual(values = c("Model Residual" = "#1f77b4",
                                  "Naive Residual" = "#ff7f0e")) +
    facet_wrap(~ Predictor, ncol = 1, scales = "free_y") +
    scale_x_datetime(date_labels = "%Y-%m-%d", date_breaks = "1 week") +
    labs(title = "Room 4 Temperature: One-Step-Ahead Residuals (Train Data)",
         subtitle = paste0("RMSE: Model = ", round(rmse_model_train, 2),
                           " | Naive = ", round(rmse_naive_train, 2)),
         x = "Date",
         y = "Residual (Predicted - Actual)") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "none")
  
  # --- TEST DATA ---
  Pred_test <- predict(fit, newdata = test_data)
  
  first_day_test <- as.Date(min(test_data$date))
  df_resid_test <- test_data %>% filter(as.Date(date) > first_day_test)
  
  Pred_test_aligned <- Pred_test$state$pred$Ti[as.Date(test_data$date) > first_day_test]
  
  df_resid_test <- df_resid_test %>%
    mutate(Resid_Model = Pred_test_aligned - yTi) %>%
    arrange(date) %>%
    mutate(Naive = lag(yTi),
           Resid_Naive = Naive - yTi) %>%
    slice(-1)
  
  # Residuals by hour plot
  df_hour_resid_test <- df_resid_test %>% mutate(Hour = hour(date))
  hour_plot_test <- ggplot(df_hour_resid_test, aes(x = Hour, y = Resid_Model)) +
    geom_jitter(width = 0.2, alpha = 0.3, color = "steelblue") +
    stat_summary(fun = mean, geom = "line", aes(group = 1), color = "black", size = 1) +
    scale_x_continuous(breaks = 0:23) +
    labs(title = "Residuals of One-Step-Ahead Prediction by Hour (Test Data, Filtered)",
         x = "Hour of Day",
         y = "Residual (Predicted - Actual)") +
    theme_minimal()
  
  df_long_test <- df_resid_test %>%
    select(date, Resid_Model, Resid_Naive) %>%
    pivot_longer(cols = c(Resid_Model, Resid_Naive),
                 names_to = "Predictor", values_to = "Residual") %>%
    mutate(Predictor = factor(Predictor, 
                              levels = c("Resid_Model", "Resid_Naive"),
                              labels = c("Model Residual", "Naive Residual")))
  
  rmse_model_test <- sqrt(mean(df_resid_test$Resid_Model^2))
  rmse_naive_test <- sqrt(mean(df_resid_test$Resid_Naive^2))
  
  stacked_plot_test <- ggplot(df_long_test, aes(x = date, y = Residual)) +
    geom_line(aes(color = Predictor), size = 1) +
    geom_hline(yintercept = 0, linetype = "dotted") +
    scale_color_manual(values = c("Model Residual" = "#1f77b4",
                                  "Naive Residual" = "#ff7f0e")) +
    facet_wrap(~ Predictor, ncol = 1, scales = "free_y") +
    scale_x_datetime(date_labels = "%Y-%m-%d", date_breaks = "1 week") +
    labs(title = "Room 4 Temperature: One-Step-Ahead Residuals (Test Data)",
         subtitle = paste0("RMSE: Model = ", round(rmse_model_test, 2),
                           " | Naive = ", round(rmse_naive_test, 2)),
         x = "Date",
         y = "Residual (Predicted - Actual)") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "none")
  
  return(list(
    train = list(hour_plot = hour_plot_train,
                 stacked_plot = stacked_plot_train,
                 RMSE_model = rmse_model_train,
                 RMSE_naive = rmse_naive_train),
    test = list(hour_plot = hour_plot_test,
                stacked_plot = stacked_plot_test,
                RMSE_model = rmse_model_test,
                RMSE_naive = rmse_naive_test)
  ))
}

```

```{r}
library("ctsmr")
fit1 <- sdeTiTm(train_data,train_data$yTi4,train_data$Ph2)
# Call the function
residual_results <- plot_residuals_train_test(fit = fit1,
                                              train_data = train_data,
                                              test_data = test_data)

# Access train hour-by-hour residual plot
residual_results$train$hour_plot

# Access train stacked residual plot
residual_results$train$stacked_plot

# Train RMSEs
residual_results$train$RMSE_model
residual_results$train$RMSE_naive

# Access test hour-by-hour residual plot
residual_results$test$hour_plot

# Access test stacked residual plot
residual_results$test$stacked_plot

# Test RMSEs
residual_results$test$RMSE_model
residual_results$test$RMSE_naive

```

```{r}
#Splines
source("Data/sdeTiTm_spline.R")
fit2 <- sdeTiTm_spline(train_data,train_data$yTi4,train_data$Ph2)

```

```{r}
# Call the function
residual_results <- plot_residuals_train_test(fit = fit2,
                                              train_data = train_data,
                                              test_data = test_data)

# Access train hour-by-hour residual plot
residual_results$train$hour_plot

# Access train stacked residual plot
residual_results$train$stacked_plot

# Train RMSEs
residual_results$train$RMSE_model
residual_results$train$RMSE_naive

# Access test hour-by-hour residual plot
residual_results$test$hour_plot

# Access test stacked residual plot
residual_results$test$stacked_plot

# Test RMSEs
residual_results$test$RMSE_model
residual_results$test$RMSE_naive
```

```{r}
#heat frac
source("Data/sdeTiTm_heatfrac.R")
fit3 <- sdeTiTm_heatfrac(train_data,train_data$yTi4,train_data$Ph2)
```

```{r}
# Call the function
residual_results <- plot_residuals_train_test(fit = fit3,
                                              train_data = train_data,
                                              test_data = test_data)

# Access train hour-by-hour residual plot
residual_results$train$hour_plot

# Access train stacked residual plot
residual_results$train$stacked_plot

# Train RMSEs
residual_results$train$RMSE_model
residual_results$train$RMSE_naive

# Access test hour-by-hour residual plot
residual_results$test$hour_plot

# Access test stacked residual plot
residual_results$test$stacked_plot

# Test RMSEs
residual_results$test$RMSE_model
residual_results$test$RMSE_naive
```

```{r}
source("Data/sdteTiTm_T3T4.R")
fit4 <- sdeTiTm_T3T4(train_data,train_data$yTi4,train_data$Ph2)
```

```{r}
# Call the function
residual_results <- plot_residuals_train_test(fit = fit4,
                                              train_data = train_data,
                                              test_data = test_data)

# Access train hour-by-hour residual plot
residual_results$train$hour_plot

# Access train stacked residual plot
residual_results$train$stacked_plot

# Train RMSEs
residual_results$train$RMSE_model
residual_results$train$RMSE_naive

# Access test hour-by-hour residual plot
residual_results$test$hour_plot

# Access test stacked residual plot
residual_results$test$stacked_plot

# Test RMSEs
residual_results$test$RMSE_model
residual_results$test$RMSE_naive
```

```{r}

AllDat_filtered <- AllDat %>%
  filter(!month(date) %in% c(4, 5))
# Define train/test split: for example, 80% train, 20% test

n_total <- nrow(AllDat_filtered)
n_train <- floor(0.8 * n_total)

# Create train and test datasets
train_data2 <- AllDat_filtered[1:n_train, ]
test_data2  <- AllDat_filtered[(n_train + 1):n_total, ]
test_data2 <- test_data2 %>%
  rename(yTi = yTi4, Ph = Ph1)
```

```{r}
fit5 <- sdeTiTm_T3T4(train_data2,train_data2$yTi4,train_data2$Ph2)
```

```{r}
# Call the function
residual_results <- plot_residuals_train_test(fit = fit5,
                                              train_data = train_data2,
                                              test_data = test_data2)

# Access train hour-by-hour residual plot
residual_results$train$hour_plot

# Access train stacked residual plot
residual_results$train$stacked_plot

# Train RMSEs
residual_results$train$RMSE_model
residual_results$train$RMSE_naive

# Access test hour-by-hour residual plot
residual_results$test$hour_plot

# Access test stacked residual plot
residual_results$test$stacked_plot

# Test RMSEs
residual_results$test$RMSE_model
residual_results$test$RMSE_naive
```
