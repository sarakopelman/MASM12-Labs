---
title: "CE3"
author: "Markus Gerholm, Sara Kopelman, Erik GÃ¶ransson"
format: html
editor: visual
---

# CE3

## Part 1: Simulation and discretization of diffusion processes

## Question 1a

```{r}
# Parameters
delta <- 2^(-9)
theta <- c(0.7, 0.8, 3.0, -0.34)
sigma <- c(0, 0.1, 0.2, 0.3, 0.4)
N <- 100/delta
```

## Simulating Y

```{r}
Y_1 <- rep(NA, N)
Y_2 <-rep(NA,N)
Y_1[1] <- -1.9
Y_2[1] <- 1.2

for(t in 2:N){
  Y_1[t] <- Y_1[t-1] + theta[3] * (Y_1[t-1] + Y_2[t-1] - (Y_1[t-1]^3)/3 + theta[4]) * delta + sigma[4] * sqrt(delta) * rnorm(1)
  Y_2[t] <- Y_2[t-1] - ((Y_1[t-1] + theta[2] * Y_2[t-1] - theta[1])/theta[3]) * delta
}
```

```{r}
par(mfrow = c(1,3), mar = c(4,4,2,1))  # 1 row, 3 columns

plot(Y_1, Y_2, type = "l")
plot(Y_1, type = "l")
plot(Y_2, type = "l")
```

## Question 1b

```{r}
# Creating grid
X <- seq(-3, 3, length.out = 100)
Y <- seq(-2, 2, length.out = 100)

snap_to_grid_simple <- function(x, grid) {
  sapply(x, function(xx) {
    if (is.na(xx)) return(NA_real_)
    g <- grid[which.min(abs(grid - xx))]
    return(g)
  })
}

Y1_snap <- snap_to_grid_simple(Y_1, X)
Y2_snap <- snap_to_grid_simple(Y_2, Y)

df <- data.frame(x = Y1_snap, y = Y2_snap)
heat_df <- as.data.frame(table(df))

bin_counts <- hist2d <- hist2d <- function(x, y, xbreaks, ybreaks) {
  counts <- table(
    cut(x, xbreaks, include.lowest = TRUE),
    cut(y, ybreaks, include.lowest = TRUE)
  )
  list(
    x = midpoints(xbreaks),
    y = midpoints(ybreaks),
    z = t(apply(counts, 2, as.numeric))
  )
}
midpoints <- function(breaks) (head(breaks, -1) + tail(breaks, -1)) / 2

h2d <- hist2d(Y_1, Y_2, X, Y)

plot_ly(
  x = h2d$x,
  y = h2d$y,
  z = h2d$z,
  type = "surface",
  colorscale = "Plasma"
) |>
  layout(
    scene = list(
      xaxis = list(title = "Y1"),
      yaxis = list(title = "Y2"),
      zaxis = list(title = "Count", showticklabels = TRUE),
      camera = list(eye = list(x = 1.5, y = 1.5, z = 1))
    )
  )
```

## Part 2: Modelling a building using CSTM-R

```{r}
library(ctsmr)
```

